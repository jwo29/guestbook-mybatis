<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.january.guestbook.mapper.BoardMapper">

    <!-- Guestbook 결과 매핑 -->
    <resultMap id="boardResultMap" type="com.january.guestbook.domain.Board">
        <id property="gno" column="gno"/>
        <result property="title" column="title"/>
        <result property="content" column="content"/>
        <result property="regDate" column="board_reg_date"/>
        <result property="modDate" column="board_mod_date"/>
        <association property="writer" javaType="com.january.guestbook.domain.Member">
            <id property="mno" column="mno"/>
            <result property="email" column="email"/>
            <result property="name" column="name"/>
        </association>
    </resultMap>

    <!-- 전체 게시글 수 조회 -->
    <select id="countAll" resultType="long">
        SELECT COUNT(*)
        FROM boards b
        INNER JOIN members m ON b.writer_no = m.mno
        WHERE gno > 0
        <if test="type != null and keyword != null and keyword != ''">
            AND (
            <trim prefixOverrides="OR">
                <if test='type.contains("t")'>
                    OR title LIKE CONCAT('%', #{keyword}, '%')
                </if>
                <if test='type.contains("c")'>
                    OR content LIKE CONCAT('%', #{keyword}, '%')
                </if>
                <if test='type.contains("w")'>
                    OR m.name LIKE CONCAT('%', #{keyword}, '%')
                </if>
            </trim>
            )
        </if>
    </select>

    <!-- 페이징 처리된 목록 조회 -->
    <select id="findAll">
        SELECT b.gno
        , b.title
        , b.content
        , b.reg_date
        , count(r.*) as reply_count
        , m.name as writer_name
        , m.email as writer_email
        FROM boards b
        INNER JOIN members m ON b.writer_no = m.mno
        LEFT JOIN replys r on b.gno = r.gno
        WHERE b.gno > 0
        <if test="type != null and keyword != null and keyword != ''">
            AND (
            <trim prefixOverrides="OR">
                <if test='type.contains("t")'>
                    OR title LIKE CONCAT('%', #{keyword}, '%')
                </if>
                <if test='type.contains("c")'>
                    OR content LIKE CONCAT('%', #{keyword}, '%')
                </if>
                <if test='type.contains("w")'>
                    OR m.name LIKE CONCAT('%', #{keyword}, '%')
                </if>
            </trim>
            )
        </if>
        GROUP BY b.gno, m.name, m.email
        ORDER BY b.gno DESC
        LIMIT #{size} OFFSET #{offset}
    </select>

    <!-- 단건 조회 -->
    <select id="findByGno" resultMap="boardResultMap">
        SELECT b.gno
             , b.title
             , b.content
             , b.reg_date as board_reg_date
             , b.mod_date as board_mod_date
             , m.mno
             , m.email
             , m.name
        FROM boards b
        INNER JOIN members m ON b.writer_no = m.mno
        WHERE gno = #{gno}
    </select>

    <!-- 게시글 등록 -->
    <insert id="insert" useGeneratedKeys="true" keyProperty="gno">
        INSERT INTO boards (title, content, writer_no, reg_date, mod_date)
        VALUES (#{title}, #{content}, #{writer.mno}, NOW(), NOW())
    </insert>

    <!-- 게시글 수정 -->
    <update id="update">
        UPDATE boards
        SET title = #{title},
            content = #{content},
            mod_date = NOW()
        WHERE gno = #{gno}
    </update>

    <!-- 게시글 삭제 -->
    <delete id="deleteByGno">
        DELETE FROM boards
        WHERE gno = #{gno}
    </delete>

</mapper>
