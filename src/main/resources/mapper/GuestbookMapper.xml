<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.january.guestbook.mapper.GuestbookMapper">

    <!-- Guestbook 결과 매핑 -->
    <resultMap id="guestbookResultMap" type="com.january.guestbook.domain.Guestbook">
        <id property="gno" column="gno"/>
        <result property="title" column="title"/>
        <result property="content" column="content"/>
        <result property="writer" column="writer"/>
        <result property="regDate" column="reg_date"/>
        <result property="modDate" column="mod_date"/>
    </resultMap>

    <!-- 전체 게시글 수 조회 -->
    <select id="countAll" resultType="long">
        SELECT COUNT(*)
        FROM guestbooks
        WHERE gno > 0
        <if test="type != null and keyword != null and keyword != ''">
            AND (
            <trim prefixOverrides="OR">
                <if test='type.contains("t")'>
                    OR title LIKE CONCAT('%', #{keyword}, '%')
                </if>
                <if test='type.contains("c")'>
                    OR content LIKE CONCAT('%', #{keyword}, '%')
                </if>
                <if test='type.contains("w")'>
                    OR writer LIKE CONCAT('%', #{keyword}, '%')
                </if>
            </trim>
            )
        </if>
    </select>

    <!-- 페이징 처리된 목록 조회 -->
    <select id="findAll" resultMap="guestbookResultMap">
        SELECT gno, title, content, writer, reg_date, mod_date
        FROM guestbooks
        WHERE gno > 0
        <if test="type != null and keyword != null and keyword != ''">
            AND (
            <trim prefixOverrides="OR">
                <if test='type.contains("t")'>
                    OR title LIKE CONCAT('%', #{keyword}, '%')
                </if>
                <if test='type.contains("c")'>
                    OR content LIKE CONCAT('%', #{keyword}, '%')
                </if>
                <if test='type.contains("w")'>
                    OR writer LIKE CONCAT('%', #{keyword}, '%')
                </if>
            </trim>
            )
        </if>
        ORDER BY gno DESC
        LIMIT #{size} OFFSET #{offset}
    </select>

    <!-- 단건 조회 -->
    <select id="findByGno" resultMap="guestbookResultMap">
        SELECT gno, title, content, writer, reg_date, mod_date
        FROM guestbooks
        WHERE gno = #{gno}
    </select>

    <!-- 게시글 등록 -->
    <insert id="insert" useGeneratedKeys="true" keyProperty="gno">
        INSERT INTO guestbooks (title, content, writer, reg_date, mod_date)
        VALUES (#{title}, #{content}, #{writer}, NOW(), NOW())
    </insert>

    <!-- 게시글 수정 -->
    <update id="update">
        UPDATE guestbooks
        SET title = #{title},
            content = #{content},
            mod_date = NOW()
        WHERE gno = #{gno}
    </update>

    <!-- 게시글 삭제 -->
    <delete id="deleteByGno">
        DELETE FROM guestbooks
        WHERE gno = #{gno}
    </delete>

</mapper>
